# Sponsored Ads Implementation

## –°—Ç–∞—Ç—É—Å: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ RPC API —Å–µ—Ä–≤–µ—Ä–∞)

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã Telegram –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. TL Helpers (`telegram_tl_helpers.py`)

–î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö pylogram –∑–∞–ø—Ä–æ—Å–æ–≤:

- ‚úÖ `make_get_sponsored_messages_query(peer)` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- ‚úÖ `make_view_sponsored_message_query(random_id)` - –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- ‚úÖ `make_click_sponsored_message_query(random_id, media, fullscreen)` - –æ—Ç–º–µ—Ç–∫–∞ –∫–ª–∏–∫–∞

### 2. Telegram Client (`telegram_client.py`)

–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã API:

- ‚úÖ `get_session_info(session_id)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏
- ‚úÖ `get_sponsored_messages(session_id, channel_username)` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –∫–∞–Ω–∞–ª–∞/–±–æ—Ç–∞
- ‚úÖ `view_sponsored_message(session_id, random_id)` - –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∫–ª–∞–º—ã
- ‚úÖ `click_sponsored_message(session_id, random_id, media, fullscreen)` - –æ—Ç–º–µ—Ç–∫–∞ –∫–ª–∏–∫–∞

### 3. Executor (`executor.py`)

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `_read_messages`:

- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –î–ª—è –Ω–µ-–ø—Ä–µ–º–∏—É–º –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç sponsored messages
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (title, message, url, button_text, recommended)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫–∞–∫ viewed (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ Telegram)
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∫–ª–∞–º–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–ª–≥–æ—Ä–∏—Ç–º

```
1. –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è read_messages:
   ‚Üì
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏ (is_premium)
   ‚Üì
3. –ï—Å–ª–∏ is_premium == false:
   ‚Üì
4. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º messages.GetSponsoredMessages(peer)
   ‚Üì
5. –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
   ‚Üì
6. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞–µ–º ViewSponsoredMessage(random_id)
   ‚Üì
7. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ (—É—Å–ø–µ—à–Ω—ã–π —Å–ª—É—á–∞–π)

```
2025-10-16 16:39:00 - executor - INFO - Reading messages in @SecretAdTestChannel for 20s
2025-10-16 16:39:00 - executor - INFO - üì± Session 27084 premium status: False
2025-10-16 16:39:00 - executor - INFO - üéØ Non-premium account - fetching official sponsored messages
2025-10-16 16:39:00 - telegram_client - INFO - üéØ Requesting sponsored messages for @SecretAdTestChannel
2025-10-16 16:39:00 - telegram_client - INFO - ‚úÖ Got sponsored messages response
2025-10-16 16:39:00 - executor - INFO - üì¢ Found 1 sponsored message(s) for @SecretAdTestChannel
2025-10-16 16:39:00 - executor - INFO -   Ad #1:
2025-10-16 16:39:00 - executor - INFO -     Title: Test Advertisement
2025-10-16 16:39:00 - executor - INFO -     Message: This is a test sponsored message
2025-10-16 16:39:00 - executor - INFO -     URL: https://t.me/example
2025-10-16 16:39:00 - executor - INFO -     Button: Open
2025-10-16 16:39:00 - executor - INFO -     Recommended: False
2025-10-16 16:39:00 - executor - INFO -     ‚úì Marked ad #1 as viewed
```

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å–∞: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ-–ø—Ä–µ–º–∏—É–º –∞–∫–∫–∞—É–Ω—Ç–æ–≤: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö TL –∑–∞–ø—Ä–æ—Å–æ–≤: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º—ã: **—Ä–∞–±–æ—Ç–∞–µ—Ç**

### ‚ö†Ô∏è –ß—Ç–æ –∂–¥–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ RPC API

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–∑–æ–≤–∞ `messages.GetSponsoredMessages` —á–µ—Ä–µ–∑ RPC API —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```
HTTP 500 Internal Server Error
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

1. RPC API —Å–µ—Ä–≤–µ—Ä (api.knyazservice.com) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥ `GetSponsoredMessages`
2. Pylogram –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–±—Ä–∞–Ω –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ sponsored messages
3. –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Layer –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. –ú–µ—Ç–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

## Compliance —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ Telegram

–°–∏—Å—Ç–µ–º–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Telegram –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 1:** –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º sponsored messages –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–Ω–∞–ª–æ–≤/–±–æ—Ç–æ–≤ –¥–ª—è –Ω–µ-–ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 2:** –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 3:** –û—Ç–º–µ—á–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã —á–µ—Ä–µ–∑ `ViewSponsoredMessage`

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 4:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ —á–µ—Ä–µ–∑ `ClickSponsoredMessage` (—Å —Ñ–ª–∞–≥–∞–º–∏ media/fullscreen)

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 5:** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è user-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–Ω–µ –±–æ—Ç–æ–≤)

‚úÖ **–ü—Ä–∞–≤–∏–ª–æ 6:** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª @SecretAdTestChannel –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# 1. –¢–µ—Å—Ç —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º
cd /Users/knyaz/heat_up
./venv/bin/python test_sponsored_ads.py 27084 @SecretAdTestChannel

# 2. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–≥—Ä–µ–≤
curl -X POST http://localhost:8080/warmup/27084

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
tail -f logs/heat_up.log | grep -E "premium|sponsored|üì±|üéØ|üì¢"
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –¢–µ—Å—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|--------|-----------|
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å–∞ | ‚úÖ Pass | `is_premium: False` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Resolve username | ‚úÖ Pass | @SecretAdTestChannel —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –≤ channel_id |
| –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ TL –∑–∞–ø—Ä–æ—Å–∞ | ‚úÖ Pass | `GetSponsoredMessages(peer=InputPeerChannel(...))` |
| RPC –≤—ã–∑–æ–≤ | ‚ö†Ô∏è Blocked | –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ | ‚úÖ Pass | –í—Å–µ –ª–æ–≥–∏ –Ω–∞ –º–µ—Å—Ç–µ |

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è –ø–æ–ª–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. **–û–±–Ω–æ–≤–∏—Ç—å RPC API —Å–µ—Ä–≤–µ—Ä** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `messages.GetSponsoredMessages`
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Layer** - —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Layer 201+
3. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è sponsored messages
4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–ª–∞–º—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Telegram Custom Client Guidelines](https://core.telegram.org/api/obtaining_api_id#custom-clients)
- [Telegram Sponsored Messages](https://core.telegram.org/method/messages.getSponsoredMessages)
- [Pylogram Layer 201](https://github.com/pylakey/pylogram/blob/main/compiler/api/source/main_api.tl)

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- ‚úÖ `telegram_tl_helpers.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã TL —Ö–µ–ª–ø–µ—Ä—ã
- ‚úÖ `telegram_client.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã API
- ‚úÖ `executor.py` - –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω `_read_messages`
- ‚úÖ `test_sponsored_ads.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** Layer 201 (pylogram==0.12.3)  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ RPC API —Å–µ—Ä–≤–µ—Ä–∞

