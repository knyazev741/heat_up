# –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–≥—Ä–µ–≤–∞ Heat Up

## –¶–µ–ª—å

–°–¥–µ–ª–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–æ–≤ –Ω–µ–æ—Ç–ª–∏—á–∏–º—ã–º –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram. –ö–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å —Å–æ —Å–≤–æ–∏–º–∏ –ø—Ä–∏–≤—ã—á–∫–∞–º–∏, –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –æ–±—â–µ–Ω–∏—è.

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –°–Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä—É–µ–º –±–æ—Ç–æ–≤ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–π —Å—Ä–µ–¥–µ (–º–µ–∂–¥—É —Å–æ–±–æ–π), –ø–æ—Ç–æ–º –≤—ã–ø—É—Å–∫–∞–µ–º –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã.

---

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| 14-–¥–Ω–µ–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–¥–∏–π | ‚úÖ | –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| LLM-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤ | ‚úÖ | DeepSeek –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| –ü–µ—Ä—Å–æ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | ‚úÖ | –ò–º—è, –∏–Ω—Ç–µ—Ä–µ—Å—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –∏—Å—Ç–æ—Ä–∏—è |
| –ë–∞–∑–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è | ‚úÖ | join_channel, read_messages, react, idle |
| –ê–Ω—Ç–∏–¥–µ—Ç–µ–∫—Ç (–±–∞–∑–æ–≤—ã–π) | ‚úÖ | –°–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, –ª–∏–º–∏—Ç—ã –ø–æ —Å—Ç–∞–¥–∏—è–º |
| –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π | ‚úÖ | SQLite —Ö—Ä–∞–Ω–∏—Ç –≤—Å—ë –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM |

### –¢–µ–∫—É—â–∏–µ —Ç–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤

| –¢–∏–ø | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ |
|-----|------------|-------------|
| –ü—Ä–æ–≥—Ä–µ–≤ (–∞–∫—Ç–∏–≤–Ω—ã–µ) | ~120 | –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏ |
| –ó–∞—Å–ø–∞–º–ª–µ–Ω–Ω—ã–µ | 50-200 | –ù–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏ –≤ –õ–°, –º–æ–≥—É—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö |

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–¢–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª—ã** ‚Äî –±–æ—Ç—ã –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —á–∞—Ç–∞—Ö –∫–∞–∫ –∂–∏–≤—ã–µ –ª—é–¥–∏
2. **–ù–µ—Ç –ª–∏—á–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è** ‚Äî –±–æ—Ç—ã –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º
3. **–ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è** ‚Äî —Ä–µ–ø–ª–∏–∫–∏ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º
4. **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã** ‚Äî –Ω–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –Ω–∏–º–∏

---

## Roadmap —Ä–∞–∑–≤–∏—Ç–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –§–ê–ó–ê 1: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è —Å—Ä–µ–¥–∞ (–º–µ–∂–¥—É —Å–≤–æ–∏–º–∏ –±–æ—Ç–∞–º–∏) ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 1.1 –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (—Å–ø–∞–º–±–ª–æ–∫) ‚úÖ                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 1.2 –õ–° –¥–∏–∞–ª–æ–≥–∏ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏ ‚úÖ                                  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 1.3 –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤ ‚úÖ                                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ 1.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö DM –∏ –æ—Ç–≤–µ—Ç—ã ‚úÖ                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –§–ê–ó–ê 2: –†–µ–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã                                    ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 2.1 –ü–æ–∏—Å–∫ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —á–∞—Ç–æ–≤                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 2.2 –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞                                           ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 2.3 –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã                                         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ 2.4 –û—Ç–≤–µ—Ç—ã –∂–∏–≤—ã–º –ª—é–¥—è–º                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –§–ê–ó–ê 3: –£–ª—É—á—à–µ–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 3.1 –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤—Ä–µ–º–µ–Ω–∏                                           ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 3.2 Stories, —Å—Ç–∏–∫–µ—Ä—ã, –≥–æ–ª–æ—Å–æ–≤—ã–µ                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ 3.3 –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –§–ê–ó–ê 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (ongoing)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –§–∞–∑–∞ 1: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è —Å—Ä–µ–¥–∞ (–ó–ê–í–ï–†–®–ï–ù–û)

### –°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û (2026-01-08)

#### –§–∞–∑–∞ 1.1: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (–ó–ê–í–ï–†–®–ï–ù–û 2026-01-08)
- [x] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 166 helper-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–∑ Admin API
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è helpers –≤ ConversationEngine –∏ GroupEngine
- [x] Helpers –º–æ–≥—É—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ DM –∏ –ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö

#### –§–∞–∑–∞ 1.2: –õ–° –¥–∏–∞–ª–æ–≥–∏ (–ó–ê–í–ï–†–®–ï–ù–û 2026-01-08)
–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç: `docs/archive/reports/PHASE_1_COMPLETION_REPORT.md`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- [x] ConversationAgent (LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)
- [x] ConversationEngine (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤)
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ status=1 —á–µ—Ä–µ–∑ Admin API
- [x] –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è access_hash
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ DM —á–µ—Ä–µ–∑ raw TL –º–µ—Ç–æ–¥—ã
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ scheduler

–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:
- [x] –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∏–∞–ª–æ–≥–∞ (3+ —Å–æ–æ–±—â–µ–Ω–∏—è)
- [x] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ status=1 —Å–µ—Å—Å–∏–π
- [x] –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
- [x] –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

#### –§–∞–∑–∞ 1.3: –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤ (–ó–ê–í–ï–†–®–ï–ù–û 2026-01-08)

–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç: `docs/archive/reports/PHASE_1_3_GROUP_CHATS_REPORT.md`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- [x] –¢–∞–±–ª–∏—Ü—ã –ë–î: bot_groups, bot_group_members, bot_group_messages
- [x] CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥—Ä—É–ø–ø –≤ database.py
- [x] GroupEngine (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –≥—Ä—É–ø–ø–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- [x] TL-—Ö–µ–ª–ø–µ—Ä—ã: make_create_chat_query, make_export_chat_invite_query
- [x] TelegramClient –º–µ—Ç–æ–¥—ã: create_group, export_chat_invite, add_user_to_chat
- [x] ConversationAgent: generate_group_message() –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GroupEngine –≤ scheduler

–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:
- [x] –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –≤ Telegram (chat_id: 5100532810, 5111704750)
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ invite link
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—É (3 —Å–æ–æ–±—â–µ–Ω–∏—è)
- [x] –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≥—Ä—É–ø–ø–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- [x] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ status=1 —Å–µ—Å—Å–∏–π (26881 –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞)

#### –§–∞–∑–∞ 1.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö DM –∏ –æ—Ç–≤–µ—Ç—ã (–ó–ê–í–ï–†–®–ï–ù–û 2026-01-08)

**–¶–µ–ª—å:** LLM –≤–∏–¥–∏—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç –Ω–∞ –Ω–∏—Ö –æ—Ç–≤–µ—Ç–∏—Ç—å

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- [x] `get_pending_incoming_dms()` –≤ database.py - –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- [x] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ pending DM –≤ –ø—Ä–æ–º–ø—Ç LLM
- [x] –ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ `reply_to_dm` –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è `reply_to_dm` –≤ llm_agent.py (conversation_id, message)
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `_reply_to_dm()` –≤ executor.py:
  - –ü–æ–ª—É—á–∞–µ—Ç conversation –∏ peer –∏–∑ –ë–î
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
  - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ conversation_messages
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
–ü—Ä–∏ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø—Ä–æ–≥—Ä–µ–≤–∞:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º get_pending_incoming_dms() –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
2. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ DM - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ–º–ø—Ç:
   üì¨ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –í –õ–°:
   - –û—Ç –ê—Ä–∏–Ω–∞ (conv_id=7): "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?..."
3. LLM –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å reply_to_dm —Å conversation_id –∏ —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞
4. executor –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î
```

### –ü–æ—á–µ–º—É —Å–Ω–∞—á–∞–ª–∞ —ç—Ç–æ?

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** ‚Äî –æ–±—â–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É —Å–≤–æ–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
2. **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ** ‚Äî –º–æ–∂–µ–º –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –±–µ–∑ —Ä–∏—Å–∫–∞ –±–∞–Ω–æ–≤
3. **–°–æ–∑–¥–∞—ë—Ç –∏—Å—Ç–æ—Ä–∏—é** ‚Äî —É –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏
4. **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ LLM** ‚Äî –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–æ –≤—ã—Ö–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã

---

### 1.1 –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (—Å–ø–∞–º–±–ª–æ–∫) ‚Äî –ó–ê–í–ï–†–®–ï–ù–û 2026-01-08

**–¶–µ–ª—å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞—Å–ø–∞–º–ª–µ–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∫–∞–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- [x] AdminAPIClient.get_helper_accounts() - –ø–æ–ª—É—á–µ–Ω–∏–µ helpers –∏–∑ Admin API
- [x] sync_helper_accounts() - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è helpers –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω –¥–ª—è helpers
- [x] get_potential_conversation_partners() - –≤–∫–ª—é—á–∞–µ—Ç helpers –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
- [x] get_accounts_without_group_membership() - –≤–∫–ª—é—á–∞–µ—Ç helpers –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø
- [x] GroupEngine - helpers –º–æ–≥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö (–Ω–æ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å)
- [x] ConversationEngine - helpers –º–æ–≥—É—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ DM (–Ω–æ –Ω–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å)
- [x] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è helpers –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ scheduler

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- 166 helper-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- 87 warmup-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω—ã
- Helpers —Å can_initiate_dm=0 (–Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏:**
- [x] `check_session_status()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª search –≤–º–µ—Å—Ç–æ get_by_id, –≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
- [x] –¢–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã —Å status=1 –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π DM

#### –¢–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–£–õ –ê–ö–ö–ê–£–ù–¢–û–í                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  WARMUP (–ø—Ä–æ–≥—Ä–µ–≤)           ‚îÇ  HELPER (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ)     ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ
‚îÇ  ‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤         ‚îÇ  ‚Ä¢ –í–µ—á–Ω—ã–π —Å–ø–∞–º–±–ª–æ–∫            ‚îÇ
‚îÇ  ‚Ä¢ –ú–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏     ‚îÇ  ‚Ä¢ –ù–ï –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏    ‚îÇ
‚îÇ  ‚Ä¢ 14-–¥–Ω–µ–≤–Ω—ã–π —Ü–∏–∫–ª          ‚îÇ  ‚Ä¢ –ú–æ–≥—É—Ç –û–¢–í–ï–ß–ê–¢–¨ –≤ –õ–°        ‚îÇ
‚îÇ  ‚Ä¢ –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª        ‚îÇ  ‚Ä¢ –ú–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö     ‚îÇ
‚îÇ  ‚Ä¢ ~120 –∞–∫–∫–∞—É–Ω—Ç–æ–≤           ‚îÇ  ‚Ä¢ 50-200 –∞–∫–∫–∞—É–Ω—Ç–æ–≤           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è DM –ø–æ —Å—Ç–∞—Ç—É—Å—É —Å–µ—Å—Å–∏–∏

#### –ü—Ä–∞–≤–∏–ª–æ 1: status=1 –≤ Admin API ‚Äî –∑–∞–ø—Ä–µ—Ç –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ DM

–ï—Å–ª–∏ —É —Å–µ—Å—Å–∏–∏ –≤ –±–∞–∑–µ Admin API `status = 1`, —Ç–æ **–ó–ê–ü–†–ï–©–ï–ù–û** –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å —ç—Ç–æ–π —Å–µ—Å—Å–∏–µ–π (–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º –≤ –õ–°).

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–ï–°–°–ò–Ø –°–û status=1 (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è)                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚ùå –ù–ï–õ–¨–ó–Ø:                        ‚îÇ  ‚úÖ –ú–û–ñ–ù–û:                          ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º –≤ –õ–°              ‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å —Å–∞–º–æ–π (–∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å)      ‚îÇ
‚îÇ    (–Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)         ‚îÇ  ‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è   ‚îÇ
‚îÇ                                    ‚îÇ  ‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥   ‚îÇ
‚îÇ                                    ‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö         ‚îÇ
‚îÇ                                    ‚îÇ  ‚Ä¢ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º DM:**

```python
async def can_initiate_dm_to_session(target_session_id: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å DM —Å —Å–µ—Å—Å–∏–µ–π"""

    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–∏–∞–ª–æ–≥ —Å —ç—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
    existing_conversation = await db.get_conversation_between(
        my_session_id, target_session_id
    )
    if existing_conversation:
        return True  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥

    # 2. –î—ë—Ä–≥–∞–µ–º Admin API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
    session_info = await admin_api.get_session(target_session_id)

    if session_info.get("status") == 1:
        logger.info(f"Skip DM to {target_session_id}: status=1")
        return False  # –ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥

    return True  # –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å
```

#### –ü—Ä–∞–≤–∏–ª–æ 2: –°–ø–∞–º–±–ª–æ–∫ (–≤–µ—á–Ω—ã–π) ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞

–°–µ—Å—Å–∏–∏ —Å –≤–µ—á–Ω—ã–º —Å–ø–∞–º–±–ª–æ–∫–æ–º (`spamblock=true AND unban_date IS NULL`):

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–ï–°–°–ò–Ø –°–û –°–ü–ê–ú–ë–õ–û–ö–û–ú (–≤–µ—á–Ω—ã–º)                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚ùå –ù–ï–õ–¨–ó–Ø:                        ‚îÇ  ‚úÖ –ú–û–ñ–ù–û:                          ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º –≤ –õ–°              ‚îÇ  ‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç     ‚îÇ
‚îÇ    (–∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)     ‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã  ‚îÇ
‚îÇ                                    ‚îÇ  ‚Ä¢ –ü–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö         ‚îÇ
‚îÇ                                    ‚îÇ  ‚Ä¢ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∞–∂–Ω–æ:** –°–ø–∞–º–±–ª–æ–∫-—Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏:
1. –ï–π –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –µ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç)
2. –ï—ë –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –õ–°)

#### –ü—Ä–∞–≤–∏–ª–æ 3: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è –¥–ª—è DM-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

DM-–¥–µ–π—Å—Ç–≤–∏—è (–ª–∏—á–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏) –¥–æ—Å—Ç—É–ø–Ω—ã **—Ç–æ–ª—å–∫–æ —Å–æ 2-–π —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–≥—Ä–µ–≤–∞ –∏ –≤—ã—à–µ**.

```python
MIN_STAGE_FOR_DM = 2  # –°—Ç–∞–¥–∏–∏ 0-1 ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª—ã, —Å—Ç–∞–¥–∏—è 2+ ‚Äî –º–æ–∂–Ω–æ DM

async def is_eligible_for_dm_actions(session_id: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏ –∫ DM-–¥–µ–π—Å—Ç–≤–∏—è–º"""

    account = await db.get_account_by_session_id(session_id)

    if account.warmup_stage < MIN_STAGE_FOR_DM:
        return False

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ —Å–ø–∞–º–±–ª–æ–∫ –ª–∏
    if account.account_type == 'helper' or not account.can_initiate_dm:
        return False  # Helper –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—á–∞—Ç—å

    return True
```

#### –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π DM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ò–ù–ò–¶–ò–ê–¢–û–† (–∫—Ç–æ –ø–∏—à–µ—Ç)      ‚Üí  –ü–û–õ–£–ß–ê–¢–ï–õ–¨ (–∫–æ–º—É –ø–∏—à—É—Ç)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                               ‚îÇ status‚â†1   ‚îÇ status=1   ‚îÇ spamblock ‚îÇ helper ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ  warmup (—Å—Ç–∞–¥–∏—è 2+)           ‚îÇ     ‚úÖ     ‚îÇ     ‚ùå     ‚îÇ     ‚úÖ    ‚îÇ   ‚úÖ   ‚îÇ
‚îÇ  warmup (—Å—Ç–∞–¥–∏—è 0-1)          ‚îÇ     ‚ùå     ‚îÇ     ‚ùå     ‚îÇ     ‚ùå    ‚îÇ   ‚ùå   ‚îÇ
‚îÇ  helper (—Å–ø–∞–º–±–ª–æ–∫)            ‚îÇ     ‚ùå*    ‚îÇ     ‚ùå     ‚îÇ     ‚ùå    ‚îÇ   ‚ùå   ‚îÇ
‚îÇ                               ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ        ‚îÇ
‚îÇ  * –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### –õ–æ–≥–∏–∫–∞ ConversationEngine —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤–∏–ª

```python
async def select_target_for_new_dm(initiator_session_id: str) -> Optional[str]:
    """–í—ã–±–æ—Ä —Ü–µ–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ DM —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"""

    initiator = await db.get_account_by_session_id(initiator_session_id)

    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–µ—Ç –ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –Ω–∞—á–∏–Ω–∞—Ç—å DM
    if initiator.warmup_stage < MIN_STAGE_FOR_DM:
        return None

    if not initiator.can_initiate_dm:
        return None

    # 2. –ü–æ–ª—É—á–∏—Ç—å –ø—É–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
    potential_targets = await db.get_accounts_for_dm(
        exclude_session_id=initiator_session_id,
        account_types=['warmup', 'helper']  # –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∏ warmup –∏ helpers
    )

    # 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ Admin API
    valid_targets = []
    for target in potential_targets:
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        existing = await db.get_active_conversation(
            initiator_session_id, target.session_id
        )
        if existing:
            continue  # –£–∂–µ –µ—Å—Ç—å –¥–∏–∞–ª–æ–≥

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ Admin API
        admin_info = await admin_api.get_session(target.session_id)
        if admin_info.get("status") == 1:
            continue  # –ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å DM

        valid_targets.append(target)

    if not valid_targets:
        return None

    # 4. –í—ã–±—Ä–∞—Ç—å —Å —É—á—ë—Ç–æ–º –ø–µ—Ä—Å–æ–Ω –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
    return await select_best_match(initiator, valid_targets)
```

---

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

```sql
-- –ù–æ–≤—ã–π —Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞
ALTER TABLE accounts ADD COLUMN account_type TEXT DEFAULT 'warmup';
-- 'warmup' = –ø—Ä–æ–≥—Ä–µ–≤, 'helper' = –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π

-- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö
ALTER TABLE accounts ADD COLUMN can_initiate_dm BOOLEAN DEFAULT TRUE;
-- FALSE –¥–ª—è helper –∞–∫–∫–∞—É–Ω—Ç–æ–≤

-- –°–≤—è–∑–∏ –º–µ–∂–¥—É –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ (–∫—Ç–æ —Å –∫–µ–º –æ–±—â–∞–µ—Ç—Å—è)
CREATE TABLE account_relationships (
    id INTEGER PRIMARY KEY,
    account_id_1 INTEGER NOT NULL,
    account_id_2 INTEGER NOT NULL,
    relationship_type TEXT,  -- 'friend', 'acquaintance', 'group_member'
    established_at TIMESTAMP,
    last_interaction_at TIMESTAMP,
    interaction_count INTEGER DEFAULT 0,
    common_groups TEXT,  -- JSON —Å–ø–∏—Å–æ–∫ –æ–±—â–∏—Ö –≥—Ä—É–ø–ø
    FOREIGN KEY (account_id_1) REFERENCES accounts(id),
    FOREIGN KEY (account_id_2) REFERENCES accounts(id),
    UNIQUE(account_id_1, account_id_2)
);
```

#### API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Admin API

```python
# scheduler.py - –¥–æ–±–∞–≤–∏—Ç—å –≤ sync_with_admin_api()

async def sync_helper_accounts(self):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–∑ Admin API"""

    # 1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—Å–ø–∞–º–ª–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    spamblocked = await self.admin_api.get_spamblocked_sessions()

    for session in spamblocked:
        # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ –ë–î
        existing = await self.db.get_account_by_session_id(session.id)

        if not existing:
            # 3. –î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ helper
            await self.db.add_account(
                session_id=session.id,
                phone_number=session.phone,
                account_type='helper',
                can_initiate_dm=False,
                is_active=True,
                # –ù–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º –ø—Ä–æ–≥—Ä–µ–≤–µ
                warmup_stage=0,
            )

            # 4. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω—É
            persona = await self.persona_agent.generate_persona(
                country=session.country,
                phone_number=session.phone
            )
            await self.db.save_persona(account_id, persona)

    logger.info(f"Synced {len(spamblocked)} helper accounts")
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] Unit: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è helper –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- [ ] Integration: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
- [ ] API: endpoint –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è helpers

---

### 1.2 –õ–° –¥–∏–∞–ª–æ–≥–∏ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏

**–¶–µ–ª—å:** –ü—Ä–æ–≥—Ä–µ–≤-–∞–∫–∫–∞—É–Ω—Ç—ã –≤–µ–¥—É—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å helper-–∞–∫–∫–∞—É–Ω—Ç–∞–º–∏

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    WARMUP –ê–ö–ö–ê–£–ù–¢                           ‚îÇ
‚îÇ                    (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚îÇ 1. –í—ã–±–∏—Ä–∞–µ—Ç helper –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
                         ‚îÇ 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    HELPER –ê–ö–ö–ê–£–ù–¢                           ‚îÇ
‚îÇ                    (–æ—Ç–≤–µ—á–∞—é—â–∏–π)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚îÇ 3. –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
                         ‚îÇ 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ LLM
                         ‚îÇ 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CONVERSATION ENGINE                            ‚îÇ
‚îÇ  ‚Ä¢ –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥                                      ‚îÇ
‚îÇ  ‚Ä¢ –°–ª–µ–¥–∏—Ç –∑–∞ –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å—é                                   ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–º–ø–æ–º (–ø–∞—É–∑—ã)                                 ‚îÇ
‚îÇ  ‚Ä¢ –†–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤

```sql
CREATE TABLE private_conversations (
    id INTEGER PRIMARY KEY,

    -- –£—á–∞—Å—Ç–Ω–∏–∫–∏
    initiator_account_id INTEGER NOT NULL,
    responder_account_id INTEGER NOT NULL,

    -- Telegram IDs –¥–ª—è –æ–±—â–µ–Ω–∏—è
    initiator_session_id TEXT NOT NULL,
    responder_session_id TEXT NOT NULL,

    -- –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞
    conversation_starter TEXT,  -- –ü—Ä–∏—á–∏–Ω–∞ –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞
    common_context TEXT,        -- –û–±—â–∏–π —á–∞—Ç/–∏–Ω—Ç–µ—Ä–µ—Å

    -- –¢–µ–º–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    current_topic TEXT,
    topics_discussed TEXT,      -- JSON –º–∞—Å—Å–∏–≤ –æ–±—Å—É–∂–¥—ë–Ω–Ω—ã—Ö —Ç–µ–º

    -- –¢–∞–π–º–∏–Ω–≥–∏
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_message_at TIMESTAMP,
    next_response_after TIMESTAMP,  -- –ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å

    -- –°—á—ë—Ç—á–∏–∫–∏
    message_count INTEGER DEFAULT 0,
    initiator_messages INTEGER DEFAULT 0,
    responder_messages INTEGER DEFAULT 0,

    -- –°–æ—Å—Ç–æ—è–Ω–∏–µ
    status TEXT DEFAULT 'active',  -- active, paused, cooling_down, ended
    end_reason TEXT,               -- natural, timeout, forced

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    quality_score REAL,            -- –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∏–∞–ª–æ–≥–∞ (0-1)

    FOREIGN KEY (initiator_account_id) REFERENCES accounts(id),
    FOREIGN KEY (responder_account_id) REFERENCES accounts(id),
    UNIQUE(initiator_account_id, responder_account_id)
);

-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–∞—Ö (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM)
CREATE TABLE conversation_messages (
    id INTEGER PRIMARY KEY,
    conversation_id INTEGER NOT NULL,
    sender_account_id INTEGER NOT NULL,
    message_text TEXT NOT NULL,
    message_type TEXT DEFAULT 'text',  -- text, sticker, voice, photo
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    telegram_message_id INTEGER,

    FOREIGN KEY (conversation_id) REFERENCES private_conversations(id),
    FOREIGN KEY (sender_account_id) REFERENCES accounts(id)
);

CREATE INDEX idx_conv_messages ON conversation_messages(conversation_id, sent_at);
```

#### –ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: start_private_conversation

```python
# executor.py

async def _start_private_conversation(self, session_id: str, params: dict) -> dict:
    """–ù–∞—á–∞—Ç—å –ª–∏—á–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –¥—Ä—É–≥–∏–º –±–æ—Ç–æ–º"""

    target_session_id = params.get("target_session_id")
    starter_message = params.get("message")

    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ target - –Ω–∞—à –±–æ—Ç
    target_account = await self.db.get_account_by_session_id(target_session_id)
    if not target_account:
        return {"error": "Target not found in our pool"}

    # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    existing = await self.db.get_active_conversation(session_id, target_session_id)
    if existing:
        return {"error": "Conversation already exists", "conversation_id": existing.id}

    # 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram
    result = await self.telegram_client.send_message(
        session_id=session_id,
        peer=target_session_id,
        text=starter_message
    )

    if result.get("error"):
        return {"error": result["error"]}

    # 4. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –æ –¥–∏–∞–ª–æ–≥–µ
    my_account = await self.db.get_account_by_session_id(session_id)
    conversation_id = await self.db.create_conversation(
        initiator_account_id=my_account.id,
        responder_account_id=target_account.id,
        initiator_session_id=session_id,
        responder_session_id=target_session_id,
        conversation_starter=starter_message,
        common_context=params.get("context"),
    )

    # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await self.db.save_conversation_message(
        conversation_id=conversation_id,
        sender_account_id=my_account.id,
        message_text=starter_message,
        telegram_message_id=result.get("message_id")
    )

    # 6. –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç helper (—á–µ—Ä–µ–∑ scheduler)
    response_delay = random.uniform(60, 300)  # 1-5 –º–∏–Ω—É—Ç
    await self.db.update_conversation(
        conversation_id,
        next_response_after=datetime.now() + timedelta(seconds=response_delay)
    )

    return {
        "success": True,
        "conversation_id": conversation_id,
        "message_sent": starter_message,
        "response_expected_in": response_delay
    }
```

#### LLM: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–µ—Ä–∞ –¥–∏–∞–ª–æ–≥–∞

```python
# conversation_agent.py (–ù–û–í–´–ô –§–ê–ô–õ)

CONVERSATION_STARTER_PROMPT = """
–¢—ã ‚Äî {my_persona.generated_name}, {my_persona.age} –ª–µ—Ç, {my_persona.occupation}.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {my_persona.communication_style}

–¢—ã —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å —á–µ–ª–æ–≤–µ–∫–æ–º:
- –ò–º—è: {their_persona.generated_name}
- –í–æ–∑—Ä–∞—Å—Ç: {their_persona.age}
- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {their_persona.occupation}
- –ò–Ω—Ç–µ—Ä–µ—Å—ã: {their_persona.interests}

–û–ë–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢ (–∫–∞–∫ –≤—ã –º–æ–≥–ª–∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è):
{common_context}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –ü–ï–†–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞.

–ü–†–ê–í–ò–õ–ê:
1. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–≤–æ–¥–æ–º –Ω–∞–ø–∏—Å–∞—Ç—å
2. –ù–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ ("–ü—Ä–∏–≤–µ—Ç, —è –ò–≤–∞–Ω")
3. –ú–æ–∂–Ω–æ:
   - –°–æ—Å–ª–∞—Ç—å—Å—è –Ω–∞ –æ–±—â–∏–π —á–∞—Ç/–∏–Ω—Ç–µ—Ä–µ—Å
   - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
   - –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ–º-—Ç–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º
4. –î–ª–∏–Ω–∞: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
5. –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –°–¢–ê–†–¢–ï–†–û–í:
- "–ü—Ä–∏–≤–µ—Ç! –í–∏–¥–µ–ª —Ç–µ–±—è –≤ —á–∞—Ç–µ –ø—Ä–æ –∫—Ä–∏–ø—Ç—É, —Ç—ã —Ç–∞–º –ø–∏—Å–∞–ª –ø—Ä–æ —Å—Ç–µ–π–∫–∏–Ω–≥. –°–∞–º –¥—É–º–∞—é –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å, –µ—Å—Ç—å –æ–ø—ã—Ç?"
- "–û, —Ç—ã —Ç–æ–∂–µ –∏–∑ –ü–∏—Ç–µ—Ä–∞? –ö–∞–∫ —Ç–∞–º –ø–æ–≥–æ–¥–∞ —Å–µ–π—á–∞—Å?"
- "–ü—Ä–∏–≤–µ—Ç! –°–ª—É—á–∞–π–Ω–æ –∑–∞–º–µ—Ç–∏–ª —Ç–≤–æ–π –∫–æ–º–º–µ–Ω—Ç –ø—Ä–æ Python, —Å–∞–º —É—á—É —Å–µ–π—á–∞—Å. –î–∞–≤–Ω–æ –≤ —ç—Ç–æ–º?"

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –¢–ï–ö–°–¢ –°–û–û–ë–©–ï–ù–ò–Ø:
"""

class ConversationAgent:
    def __init__(self, llm_client):
        self.llm = llm_client

    async def generate_conversation_starter(
        self,
        my_persona: dict,
        their_persona: dict,
        common_context: str = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞"""

        # –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ - –Ω–∞–π—Ç–∏ –æ–±—â–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã
        if not common_context:
            common_interests = set(my_persona.get("interests", [])) & \
                              set(their_persona.get("interests", []))
            if common_interests:
                common_context = f"–û–±—â–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {', '.join(common_interests)}"
            else:
                common_context = "–°–ª—É—á–∞–π–Ω–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ –≤ Telegram"

        prompt = CONVERSATION_STARTER_PROMPT.format(
            my_persona=my_persona,
            their_persona=their_persona,
            common_context=common_context
        )

        response = await self.llm.generate(
            prompt=prompt,
            temperature=0.9,
            max_tokens=100
        )

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        validated = await self._validate_starter(response)
        return validated

    async def _validate_starter(self, text: str) -> str:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—Ç–µ—Ä–∞ –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å"""

        # –£–±—Ä–∞—Ç—å –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        text = text.strip().strip('"\'')

        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        if len(text) < 5:
            return None
        if len(text) > 300:
            text = text[:300]

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–ø–∞–º-—Å–ª–æ–≤–∞
        spam_patterns = ['–∑–∞—Ä–∞–±–æ—Ç–æ–∫', '–∏–Ω–≤–µ—Å—Ç–∏—Ü', '–±–µ—Å–ø–ª–∞—Ç–Ω–æ', '–∞–∫—Ü–∏—è', '—Å–∫–∏–¥–∫']
        if any(p in text.lower() for p in spam_patterns):
            return None

        return text
```

#### LLM: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥–µ

```python
CONVERSATION_RESPONSE_PROMPT = """
–¢—ã ‚Äî {my_persona.generated_name}, {my_persona.age} –ª–µ—Ç, {my_persona.occupation}.
–•–∞—Ä–∞–∫—Ç–µ—Ä: {my_persona.personality_traits}
–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {my_persona.communication_style}

–ò–°–¢–û–†–ò–Ø –ü–ï–†–ï–ü–ò–°–ö–ò:
{conversation_history}

–°–û–ë–ï–°–ï–î–ù–ò–ö:
{their_persona.generated_name}, {their_persona.age} –ª–µ—Ç, {their_persona.occupation}

–¢–ï–ö–£–©–ê–Ø –¢–ï–ú–ê: {current_topic}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
2. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏
3. –ú–æ–∂–µ—à—å:
   - –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
   - –ó–∞–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã
   - –î–µ–ª–∏—Ç—å—Å—è –º–Ω–µ–Ω–∏–µ–º/–æ–ø—ã—Ç–æ–º
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ (—É–º–µ—Ä–µ–Ω–Ω–æ)
   - –®—É—Ç–∏—Ç—å –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
4. –î–ª–∏–Ω–∞: 1-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
5. –ù–ï –ù–ê–î–û:
   - –ü–∏—Å–∞—Ç—å —Å–ª–∏—à–∫–æ–º —Ñ–æ—Ä–º–∞–ª—å–Ω–æ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç
   - –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Ç–æ —á—Ç–æ —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª
   - –†–µ–∑–∫–æ –º–µ–Ω—è—Ç—å —Ç–µ–º—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:
- –°—Ç–∏–∫–µ—Ä: [STICKER:–∫–∞—Ç–µ–≥–æ—Ä–∏—è] (happy, sad, ok, lol, etc)
- –ì–æ–ª–æ—Å–æ–≤–æ–µ: [VOICE:—Ç–µ–∫—Å—Ç –∫–æ—Ç–æ—Ä—ã–π —Å–∫–∞–∑–∞—Ç—å]

–û–¢–í–ï–¢:
"""

async def generate_conversation_response(
    self,
    my_persona: dict,
    their_persona: dict,
    conversation_history: list,
    current_topic: str = None
) -> dict:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥–µ"""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
    history_text = self._format_conversation_history(conversation_history)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–∞
    if not current_topic:
        current_topic = await self._extract_topic(conversation_history)

    prompt = CONVERSATION_RESPONSE_PROMPT.format(
        my_persona=my_persona,
        their_persona=their_persona,
        conversation_history=history_text,
        current_topic=current_topic
    )

    response = await self.llm.generate(
        prompt=prompt,
        temperature=0.85,
        max_tokens=150
    )

    # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    return self._parse_response(response)

def _parse_response(self, response: str) -> dict:
    """–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ LLM"""

    result = {"type": "text", "content": response}

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å—Ç–∏–∫–µ—Ä
    if "[STICKER:" in response:
        match = re.search(r'\[STICKER:(\w+)\]', response)
        if match:
            result = {"type": "sticker", "category": match.group(1)}

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–æ–µ
    elif "[VOICE:" in response:
        match = re.search(r'\[VOICE:(.+?)\]', response)
        if match:
            result = {"type": "voice", "content": match.group(1)}

    else:
        # –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç - –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        result["content"] = response.strip().strip('"\'')

    return result

def _format_conversation_history(self, messages: list) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""

    lines = []
    for msg in messages[-15:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å–æ–æ–±—â–µ–Ω–∏–π
        sender = "–¢—ã" if msg.is_mine else msg.sender_name
        lines.append(f"{sender}: {msg.text}")

    return "\n".join(lines)
```

#### Conversation Engine (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤)

```python
# conversation_engine.py (–ù–û–í–´–ô –§–ê–ô–õ)

class ConversationEngine:
    """
    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ scheduler, —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏.
    """

    def __init__(self, db, telegram_client, conversation_agent):
        self.db = db
        self.telegram = telegram_client
        self.agent = conversation_agent

    async def process_pending_responses(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –≥–¥–µ –ø–æ—Ä–∞ –æ—Ç–≤–µ—á–∞—Ç—å"""

        # 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ –≥–¥–µ –ø–æ—Ä–∞ –æ—Ç–≤–µ—á–∞—Ç—å
        pending = await self.db.get_conversations_needing_response()

        for conversation in pending:
            try:
                await self._process_conversation(conversation)
            except Exception as e:
                logger.error(f"Error processing conversation {conversation.id}: {e}")

    async def _process_conversation(self, conversation):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥"""

        # 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫—Ç–æ –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å
        last_message = await self.db.get_last_conversation_message(conversation.id)

        if last_message.sender_account_id == conversation.initiator_account_id:
            # –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ -> –æ—Ç–≤–µ—á–∞–µ—Ç responder
            responder_id = conversation.responder_account_id
            responder_session = conversation.responder_session_id
        else:
            # –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç responder -> –æ—Ç–≤–µ—á–∞–µ—Ç initiator
            responder_id = conversation.initiator_account_id
            responder_session = conversation.initiator_session_id

        # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ –ø–æ—Ä–∞ –ª–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥
        if await self._should_end_conversation(conversation):
            await self._end_conversation(conversation, responder_session)
            return

        # 3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω—ã
        my_account = await self.db.get_account_by_id(responder_id)
        my_persona = await self.db.get_persona(responder_id)

        other_id = conversation.initiator_account_id \
            if responder_id == conversation.responder_account_id \
            else conversation.responder_account_id
        their_persona = await self.db.get_persona(other_id)

        # 4. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        history = await self.db.get_conversation_messages(conversation.id)

        # 5. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
        response = await self.agent.generate_conversation_response(
            my_persona=my_persona,
            their_persona=their_persona,
            conversation_history=history,
            current_topic=conversation.current_topic
        )

        if not response or not response.get("content"):
            logger.warning(f"Empty response for conversation {conversation.id}")
            return

        # 6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
        peer_session = conversation.initiator_session_id \
            if responder_id == conversation.responder_account_id \
            else conversation.responder_session_id

        if response["type"] == "text":
            result = await self.telegram.send_message(
                session_id=responder_session,
                peer=peer_session,
                text=response["content"]
            )
        elif response["type"] == "sticker":
            result = await self._send_sticker(responder_session, peer_session, response["category"])
        elif response["type"] == "voice":
            result = await self._send_voice(responder_session, peer_session, response["content"])

        if result.get("error"):
            logger.error(f"Failed to send message: {result['error']}")
            return

        # 7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        await self.db.save_conversation_message(
            conversation_id=conversation.id,
            sender_account_id=responder_id,
            message_text=response.get("content", f"[{response['type']}]"),
            message_type=response["type"],
            telegram_message_id=result.get("message_id")
        )

        # 8. –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥
        next_delay = self._calculate_next_response_delay(conversation)
        await self.db.update_conversation(
            conversation.id,
            message_count=conversation.message_count + 1,
            last_message_at=datetime.now(),
            next_response_after=datetime.now() + timedelta(seconds=next_delay)
        )

    def _calculate_next_response_delay(self, conversation) -> int:
        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞"""

        # –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1-5 –º–∏–Ω—É—Ç
        base_delay = random.uniform(60, 300)

        # –ß–µ–º –¥–æ–ª—å—à–µ –¥–∏–∞–ª–æ–≥, —Ç–µ–º –±–æ–ª—å—à–µ –ø–∞—É–∑—ã
        if conversation.message_count > 10:
            base_delay *= 1.5
        if conversation.message_count > 20:
            base_delay *= 2

        # –ò–Ω–æ–≥–¥–∞ –±–æ–ª—å—à–∏–µ –ø–∞—É–∑—ã (—á–µ–ª–æ–≤–µ–∫ –∑–∞–Ω—è—Ç)
        if random.random() < 0.1:
            base_delay += random.uniform(600, 1800)  # +10-30 –º–∏–Ω—É—Ç

        return int(base_delay)

    async def _should_end_conversation(self, conversation) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä–∞ –ª–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥"""

        # –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        if conversation.message_count >= 30:
            return True

        # –î–∏–∞–ª–æ–≥ –∏–¥—ë—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
        age = datetime.now() - conversation.started_at
        if age.total_seconds() > 48 * 3600:  # 48 —á–∞—Å–æ–≤
            return True

        # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ 15 —Å–æ–æ–±—â–µ–Ω–∏–π
        if conversation.message_count > 15 and random.random() < 0.2:
            return True

        return False

    async def _end_conversation(self, conversation, session_id: str):
        """–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ"""

        # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—â–∞–Ω–∏–µ
        my_persona = await self.db.get_persona_by_session(session_id)

        closing = await self.agent.generate_closing_message(my_persona)

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        peer_session = conversation.initiator_session_id \
            if session_id == conversation.responder_session_id \
            else conversation.responder_session_id

        await self.telegram.send_message(
            session_id=session_id,
            peer=peer_session,
            text=closing
        )

        # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        await self.db.update_conversation(
            conversation.id,
            status='ended',
            end_reason='natural'
        )
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –õ–° –¥–∏–∞–ª–æ–≥–æ–≤

```python
# tests/test_private_conversations.py

class TestPrivateConversations:

    async def test_start_conversation(self):
        """–¢–µ—Å—Ç –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞"""
        # 1. –°–æ–∑–¥–∞—Ç—å warmup –∏ helper –∞–∫–∫–∞—É–Ω—Ç—ã
        # 2. –í—ã–∑–≤–∞—Ç—å start_private_conversation
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î

    async def test_response_generation(self):
        """–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤"""
        # 1. –°–æ–∑–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        # 2. –í—ã–∑–≤–∞—Ç—å generate_conversation_response
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
        # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

    async def test_conversation_flow(self):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –¥–∏–∞–ª–æ–≥–∞"""
        # 1. –ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥
        # 2. –û–±–º–µ–Ω—è—Ç—å—Å—è 5-10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–∞—É–∑
        # 4. –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥

    async def test_helper_cannot_initiate(self):
        """–¢–µ—Å—Ç —á—Ç–æ helper –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥"""
        # 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –æ—Ç helper
        # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –æ—à–∏–±–∫—É
```

---

### 1.3 –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤

**–¶–µ–ª—å:** –ë–æ—Ç—ã —Å–æ–∑–¥–∞—é—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∏ –æ–±—â–∞—é—Ç—Å—è –≤ –Ω–∏—Ö

#### –ó–∞—á–µ–º –Ω—É–∂–Ω—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã?

1. **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤** ‚Äî —É—á–∏–º—Å—è –æ–±—â–∞—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø–∞—Ö –¥–æ –≤—ã—Ö–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏** ‚Äî —É –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≥—Ä—É–ø–ø—ã –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ —Å–æ—Å—Ç–æ—è—Ç
3. **–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏** ‚Äî –±–æ—Ç—ã –∑–Ω–∞–∫–æ–º—è—Ç—Å—è —á–µ—Ä–µ–∑ –≥—Ä—É–ø–ø—ã
4. **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å** ‚Äî —É –ª—é–¥–µ–π –µ—Å—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Å –¥—Ä—É–∑—å—è–º–∏

#### –¢–∏–ø—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –¢–ò–ü–´ –ü–†–ò–í–ê–¢–ù–´–• –ì–†–£–ü–ü                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. –¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ì–†–£–ü–ü–ê                                     ‚îÇ
‚îÇ     ‚Ä¢ 3-8 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –æ–±—â–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–æ–º                      ‚îÇ
‚îÇ     ‚Ä¢ –û–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–µ–º—ã (–∫—Ä–∏–ø—Ç–∞, IT, –∫–∏–Ω–æ –∏ —Ç.–¥.)            ‚îÇ
‚îÇ     ‚Ä¢ –£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å                                  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  2. –ì–†–£–ü–ü–ê –î–†–£–ó–ï–ô                                           ‚îÇ
‚îÇ     ‚Ä¢ 3-5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤                                        ‚îÇ
‚îÇ     ‚Ä¢ –û–±—â–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã                                ‚îÇ
‚îÇ     ‚Ä¢ –ë–æ–ª–µ–µ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ                            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  3. –†–ê–ë–û–ß–ê–Ø –ì–†–£–ü–ü–ê                                          ‚îÇ
‚îÇ     ‚Ä¢ 2-4 —É—á–∞—Å—Ç–Ω–∏–∫–∞                                         ‚îÇ
‚îÇ     ‚Ä¢ –û–±—Å—É–∂–¥–µ–Ω–∏–µ "–ø—Ä–æ–µ–∫—Ç–∞"                                  ‚îÇ
‚îÇ     ‚Ä¢ –î–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤
CREATE TABLE bot_groups (
    id INTEGER PRIMARY KEY,

    -- Telegram –¥–∞–Ω–Ω—ã–µ
    telegram_chat_id INTEGER,
    telegram_invite_link TEXT,
    group_title TEXT NOT NULL,
    group_description TEXT,

    -- –¢–∏–ø –∏ —Ç–µ–º–∞
    group_type TEXT NOT NULL,  -- thematic, friends, work
    topic TEXT,                -- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è

    -- –°–æ–∑–¥–∞—Ç–µ–ª—å
    creator_account_id INTEGER NOT NULL,

    -- –°–æ—Å—Ç–æ—è–Ω–∏–µ
    status TEXT DEFAULT 'active',  -- active, archived
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity_at TIMESTAMP,

    -- –°—á—ë—Ç—á–∏–∫–∏
    member_count INTEGER DEFAULT 1,
    message_count INTEGER DEFAULT 0,

    FOREIGN KEY (creator_account_id) REFERENCES accounts(id)
);

-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø
CREATE TABLE bot_group_members (
    id INTEGER PRIMARY KEY,
    group_id INTEGER NOT NULL,
    account_id INTEGER NOT NULL,

    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_message_at TIMESTAMP,
    message_count INTEGER DEFAULT 0,

    role TEXT DEFAULT 'member',  -- admin, member

    FOREIGN KEY (group_id) REFERENCES bot_groups(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    UNIQUE(group_id, account_id)
);

-- –°–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
CREATE TABLE bot_group_messages (
    id INTEGER PRIMARY KEY,
    group_id INTEGER NOT NULL,
    sender_account_id INTEGER NOT NULL,

    message_text TEXT,
    message_type TEXT DEFAULT 'text',
    reply_to_message_id INTEGER,

    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    telegram_message_id INTEGER,

    FOREIGN KEY (group_id) REFERENCES bot_groups(id),
    FOREIGN KEY (sender_account_id) REFERENCES accounts(id)
);

CREATE INDEX idx_group_messages ON bot_group_messages(group_id, sent_at);
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã

```python
# executor.py

async def _create_bot_group(self, session_id: str, params: dict) -> dict:
    """–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—É—é –≥—Ä—É–ø–ø—É —Å –¥—Ä—É–≥–∏–º–∏ –±–æ—Ç–∞–º–∏"""

    group_title = params.get("title")
    group_type = params.get("type", "friends")  # thematic, friends, work
    topic = params.get("topic")
    member_session_ids = params.get("members", [])

    # 1. –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –≤ Telegram
    result = await self.telegram_client.create_group(
        session_id=session_id,
        title=group_title,
        user_ids=member_session_ids  # –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—Ä–∞–∑—É
    )

    if result.get("error"):
        return {"error": result["error"]}

    telegram_chat_id = result.get("chat_id")
    invite_link = result.get("invite_link")

    # 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    my_account = await self.db.get_account_by_session_id(session_id)

    group_id = await self.db.create_bot_group(
        telegram_chat_id=telegram_chat_id,
        telegram_invite_link=invite_link,
        group_title=group_title,
        group_type=group_type,
        topic=topic,
        creator_account_id=my_account.id
    )

    # 3. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–∫ –∞–¥–º–∏–Ω–∞
    await self.db.add_group_member(
        group_id=group_id,
        account_id=my_account.id,
        role='admin'
    )

    # 4. –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    for member_session_id in member_session_ids:
        member_account = await self.db.get_account_by_session_id(member_session_id)
        if member_account:
            await self.db.add_group_member(
                group_id=group_id,
                account_id=member_account.id,
                role='member'
            )

    return {
        "success": True,
        "group_id": group_id,
        "telegram_chat_id": telegram_chat_id,
        "members_added": len(member_session_ids) + 1
    }
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ

```python
GROUP_MESSAGE_PROMPT = """
–¢—ã ‚Äî {my_persona.generated_name}, —É—á–∞—Å—Ç–Ω–∏–∫ –≥—Ä—É–ø–ø—ã "{group_title}".

–¢–í–û–ô –ü–†–û–§–ò–õ–¨:
- –í–æ–∑—Ä–∞—Å—Ç: {my_persona.age}
- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {my_persona.occupation}
- –ò–Ω—Ç–µ—Ä–µ—Å—ã: {my_persona.interests}
- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {my_persona.communication_style}

–¢–ï–ú–ê –ì–†–£–ü–ü–´: {group_topic}
–¢–ò–ü –ì–†–£–ü–ü–´: {group_type}

–î–†–£–ì–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ò:
{other_members}

–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø:
{recent_messages}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É.

–ü–†–ê–í–ò–õ–ê:
1. –£—á–∏—Ç—ã–≤–∞–π —Ç–µ–º—É –≥—Ä—É–ø–ø—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
2. –ú–æ–∂–µ—à—å:
   - –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —á—å—ë-—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (—É–∫–∞–∂–∏ @–∏–º—è)
   - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –≥—Ä—É–ø–ø–µ
   - –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–Ω–µ–Ω–∏–µ–º/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   - –ü–æ—à—É—Ç–∏—Ç—å –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
3. –î–ª–∏–Ω–∞: 1-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
4. –°—Ç–∏–ª—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –≥—Ä—É–ø–ø—ã:
   - friends: –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —à—É—Ç–∏—Ç—å
   - thematic: –ø–æ —Ç–µ–º–µ, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ
   - work: –¥–µ–ª–æ–≤–æ–π, –ø–æ —Å—É—â–µ—Å—Ç–≤—É

–û–¢–í–ï–¢ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç):
"""

async def generate_group_message(
    self,
    my_persona: dict,
    group: BotGroup,
    other_members: list,
    recent_messages: list
) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã"""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    members_text = "\n".join([
        f"- {m.name}, {m.age} –ª–µ—Ç, {m.occupation}"
        for m in other_members
    ])

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    messages_text = "\n".join([
        f"{m.sender_name}: {m.text}"
        for m in recent_messages[-20:]
    ])

    prompt = GROUP_MESSAGE_PROMPT.format(
        my_persona=my_persona,
        group_title=group.group_title,
        group_topic=group.topic,
        group_type=group.group_type,
        other_members=members_text,
        recent_messages=messages_text
    )

    response = await self.llm.generate(
        prompt=prompt,
        temperature=0.9,
        max_tokens=150
    )

    return response.strip().strip('"\'')
```

#### Group Engine (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –≥—Ä—É–ø–ø)

```python
# group_engine.py (–ù–û–í–´–ô –§–ê–ô–õ)

class GroupEngine:
    """
    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –±–æ—Ç–æ–≤.
    """

    async def process_group_activity(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ –≤—Å–µ—Ö –≥—Ä—É–ø–ø–∞—Ö"""

        active_groups = await self.db.get_active_bot_groups()

        for group in active_groups:
            # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫—Ç–æ –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å
            next_sender = await self._select_next_sender(group)

            if next_sender and await self._should_send_message(group, next_sender):
                await self._send_group_message(group, next_sender)

    async def _select_next_sender(self, group: BotGroup) -> Optional[int]:
        """–í—ã–±—Ä–∞—Ç—å –∫—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–ø–∏—à–µ—Ç –≤ –≥—Ä—É–ø–ø—É"""

        members = await self.db.get_group_members(group.id)

        # –ò—Å–∫–ª—é—á–∏—Ç—å —Ç–æ–≥–æ –∫—Ç–æ –ø–∏—Å–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º
        last_message = await self.db.get_last_group_message(group.id)
        eligible = [m for m in members if m.account_id != last_message.sender_account_id]

        if not eligible:
            return None

        # –í–∑–≤–µ—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä - –∫—Ç–æ –¥–∞–≤–Ω–æ –Ω–µ –ø–∏—Å–∞–ª, —Ç–æ—Ç –≤–µ—Ä–æ—è—Ç–Ω–µ–µ
        weights = []
        for member in eligible:
            time_since_last = (datetime.now() - (member.last_message_at or group.created_at)).total_seconds()
            weight = min(time_since_last / 3600, 10)  # –ú–∞–∫—Å –≤–µ—Å —á–µ—Ä–µ–∑ 10 —á–∞—Å–æ–≤
            weights.append(weight)

        return random.choices(eligible, weights=weights, k=1)[0].account_id

    async def _should_send_message(self, group: BotGroup, account_id: int) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"""

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ
        last_message = await self.db.get_last_group_message(group.id)
        if last_message:
            time_since_last = (datetime.now() - last_message.sent_at).total_seconds()

            # –ú–∏–Ω–∏–º—É–º 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            if time_since_last < 300:
                return False

        # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
        probability = min(time_since_last / 3600, 0.8)  # –ú–∞–∫—Å 80% —á–µ—Ä–µ–∑ —á–∞—Å

        return random.random() < probability

    async def _send_group_message(self, group: BotGroup, account_id: int):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É"""

        account = await self.db.get_account_by_id(account_id)
        persona = await self.db.get_persona(account_id)

        # –ü–æ–ª—É—á–∏—Ç—å –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        members = await self.db.get_group_members(group.id)
        other_personas = [
            await self.db.get_persona(m.account_id)
            for m in members if m.account_id != account_id
        ]

        # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        messages = await self.db.get_group_messages(group.id, limit=30)

        # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        text = await self.agent.generate_group_message(
            my_persona=persona,
            group=group,
            other_members=other_personas,
            recent_messages=messages
        )

        if not text:
            return

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        result = await self.telegram.send_message(
            session_id=account.session_id,
            peer=group.telegram_chat_id,
            text=text
        )

        if result.get("error"):
            logger.error(f"Failed to send group message: {result['error']}")
            return

        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        await self.db.save_group_message(
            group_id=group.id,
            sender_account_id=account_id,
            message_text=text,
            telegram_message_id=result.get("message_id")
        )

        # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        await self.db.update_group(
            group.id,
            last_activity_at=datetime.now(),
            message_count=group.message_count + 1
        )
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø

```python
# tests/test_bot_groups.py

class TestBotGroups:

    async def test_create_group(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã"""
        # 1. –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Å 3 —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≥—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ Telegram
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –ë–î

    async def test_group_conversation(self):
        """–¢–µ—Å—Ç –æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ"""
        # 1. –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        # 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å GroupEngine
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–∏—à—É—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏
        # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π

    async def test_member_selection(self):
        """–¢–µ—Å—Ç –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
        # 1. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—ã–±–æ—Ä —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π
        # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∏—Å–∞–≤—à–∏–π –Ω–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è
```

---

### 1.4 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Scheduler

```python
# scheduler.py

class WarmupScheduler:
    def __init__(self, ...):
        ...
        self.conversation_engine = ConversationEngine(...)
        self.group_engine = GroupEngine(...)

    async def scheduler_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""

        while self.is_running:
            try:
                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤
                await self._process_warmup_accounts()

                # –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                await self.conversation_engine.process_pending_responses()

                # –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö
                await self.group_engine.process_group_activity()

                # –ù–û–í–û–ï: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤/–≥—Ä—É–ø–ø
                await self._initiate_new_social_activities()

            except Exception as e:
                logger.error(f"Scheduler error: {e}")

            await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

    async def _initiate_new_social_activities(self):
        """–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""

        # 1. –ù–∞–π—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç—ã –±–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
        lonely_accounts = await self.db.get_accounts_without_conversations(
            min_stage=3,  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 3 –¥–Ω—è –ø—Ä–æ–≥—Ä–µ–≤–∞
            max_conversations=2  # –£ –∫–æ–≥–æ –º–µ–Ω—å—à–µ 2 –¥–∏–∞–ª–æ–≥–æ–≤
        )

        for account in lonely_accounts[:5]:  # –ú–∞–∫—Å–∏–º—É–º 5 –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∑–∞ —Ü–∏–∫–ª
            # –í—ã–±—Ä–∞—Ç—å helper –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
            helper = await self._select_conversation_partner(account)
            if helper:
                await self._start_new_conversation(account, helper)

        # 2. –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã (—Ä–µ–¥–∫–æ)
        if random.random() < 0.05:  # 5% —à–∞–Ω—Å –∑–∞ —Ü–∏–∫–ª
            await self._create_new_bot_group()
```

---

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 1

#### –ß–µ–∫-–ª–∏—Å—Ç (–û–ë–ù–û–í–õ–ï–ù–û 2026-01-08)

```
HELPER –ê–ö–ö–ê–£–ù–¢–´:
[x] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Admin API (status check)
[x] –§–ª–∞–≥–∏ can_initiate_dm —Ä–∞–±–æ—Ç–∞—é—Ç
[ ] –ü–µ—Ä—Å–æ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–ª—è helpers (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)

–õ–ò–ß–ù–´–ï –î–ò–ê–õ–û–ì–ò (–§–∞–∑–∞ 1.2):
[x] Warmup –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –¥—Ä—É–≥–∏–º warmup
[x] –ê–∫–∫–∞—É–Ω—Ç—ã —Å–æ status=1 –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è DM
[x] –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—á–µ—Ä–µ–∑ import_contact + send_dm)
[x] –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ private_conversations
[x] –ü–∞—É–∑—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (30-600 —Å–µ–∫)
[x] –î–∏–∞–ª–æ–≥–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ (–ø–æ—Å–ª–µ 15-30 —Å–æ–æ–±—â–µ–Ω–∏–π)
[x] LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (DeepSeek)

–ü–†–ò–í–ê–¢–ù–´–ï –ì–†–£–ü–ü–´ (–§–∞–∑–∞ 1.3 - –ó–ê–í–ï–†–®–ï–ù–û 2026-01-08):
[x] –¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã (bot_groups, bot_group_members, bot_group_messages)
[x] GroupEngine —Å–æ–∑–¥–∞–Ω (group_engine.py)
[x] TL-–º–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø (messages.CreateChat)
[x] TelegramClient.create_group() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
[x] generate_group_message() –≤ ConversationAgent
[x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ scheduler
[x] –¢–µ—Å—Ç: –≥—Ä—É–ø–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ Telegram (chat_id: 5100532810, 5111704750)
[x] –¢–µ—Å—Ç: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ invite link
[x] –¢–µ—Å—Ç: —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è (3 —Å–æ–æ–±—â–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ)
[x] –¢–µ—Å—Ç: –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π (27060, 27065 —á–µ—Ä–µ–¥—É—é—Ç—Å—è)
[x] –¢–µ—Å—Ç: —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (DeepSeek –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)

–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø:
[x] ConversationEngine —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ scheduler
[x] GroupEngine —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ scheduler
[x] –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–æ–≥—Ä–µ–≤–æ–º
[x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
```

---

## –§–∞–∑–∞ 2: –†–µ–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã

> **–í–Ω–∏–º–∞–Ω–∏–µ:** –ù–∞—á–∏–Ω–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –§–∞–∑—ã 1!

### 2.1 –ü–æ–∏—Å–∫ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —á–∞—Ç–æ–≤

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –±–æ—Ç—ã –Ω–∞—É—á–∏–ª–∏—Å—å –æ–±—â–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π, –º–æ–∂–Ω–æ –≤—ã–ø—É—Å–∫–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã.

```python
# search_agent.py - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

async def find_public_group_chats(self, persona: dict) -> list:
    """–ü–æ–∏—Å–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º"""

    queries = self._generate_group_search_queries(persona)
    # –ü—Ä–∏–º–µ—Ä—ã: "python —á–∞—Ç telegram", "–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –æ–±—Å—É–∂–¥–µ–Ω–∏–µ"

    groups = []

    # 1. –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Google
    for query in queries[:3]:
        results = await self.google_search(f"{query} telegram –≥—Ä—É–ø–ø–∞")
        groups.extend(self._extract_telegram_links(results))

    # 2. –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Telegram –∫–∞—Ç–∞–ª–æ–≥–∏
    # @TGStat_Bot, –∫–æ–º—å—é–Ω–∏—Ç–∏-–∫–∞—Ç–∞–ª–æ–≥–∏

    # 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è - —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã (–Ω–µ –∫–∞–Ω–∞–ª—ã)
    verified_groups = []
    for group in groups:
        info = await self.telegram_client.get_chat_info(group)
        if info.get("type") in ["group", "supergroup"]:
            verified_groups.append({
                "username": group,
                "title": info.get("title"),
                "member_count": info.get("member_count"),
                "type": info.get("type")
            })

    # 4. –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ LLM
    return await self._rank_by_relevance(verified_groups, persona)
```

### 2.2 –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º

```python
async def analyze_chat_before_responding(
    self,
    session_id: str,
    chat_id: int,
    persona: dict
) -> dict:
    """–ê–Ω–∞–ª–∏–∑ —á–∞—Ç–∞ –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å"""

    # 1. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    messages = await self.telegram.get_chat_history(session_id, chat_id, limit=50)

    # 2. –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM
    analysis = await self.llm.analyze(f"""
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç:

    –°–û–û–ë–©–ï–ù–ò–Ø:
    {self._format_messages(messages)}

    –ü–ï–†–°–û–ù–ê –ö–û–¢–û–†–ê–Ø –•–û–ß–ï–¢ –û–¢–í–ï–¢–ò–¢–¨:
    {persona}

    –û–¢–í–ï–¢–¨:
    1. –û —á—ë–º —Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä—è—Ç? (—Ç–µ–º–∞)
    2. –ö–∞–∫–æ–π —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è? (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)
    3. –ï—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å?
    4. –£–º–µ—Å—Ç–Ω–æ –ª–∏ —Å–µ–π—á–∞—Å –≤—Å—Ç—É–ø–∏—Ç—å –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä?
    5. –ï—Å–ª–∏ –¥–∞ - –∫–∞–∫–æ–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥–æ–π–¥—ë—Ç?

    JSON:
    """)

    return json.loads(analysis)
```

### 2.3-2.4 (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–ª–∞–Ω–∞)

---

## –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

### 3.1 –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤—Ä–µ–º–µ–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

(—Å–º. –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–Ω–∞)

### 3.2 Stories, —Å—Ç–∏–∫–µ—Ä—ã, –≥–æ–ª–æ—Å–æ–≤—ã–µ

(—Å–º. –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–Ω–∞)

### 3.3 –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏

(—Å–º. –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–Ω–∞)

---

## –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_conversation_agent.py
‚îÇ   ‚îú‚îÄ‚îÄ test_conversation_engine.py
‚îÇ   ‚îú‚îÄ‚îÄ test_group_engine.py
‚îÇ   ‚îî‚îÄ‚îÄ test_validators.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test_private_conversations.py
‚îÇ   ‚îú‚îÄ‚îÄ test_bot_groups.py
‚îÇ   ‚îî‚îÄ‚îÄ test_real_chat_participation.py
‚îú‚îÄ‚îÄ behavior/
‚îÇ   ‚îú‚îÄ‚îÄ test_conversation_quality.py
‚îÇ   ‚îú‚îÄ‚îÄ test_timing_patterns.py
‚îÇ   ‚îî‚îÄ‚îÄ test_message_relevance.py
‚îî‚îÄ‚îÄ safety/
    ‚îú‚îÄ‚îÄ test_content_filtering.py
    ‚îî‚îÄ‚îÄ test_spam_prevention.py
```

### Mock –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```python
class TelegramMock:
    """Mock Telegram API –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram"""

    def __init__(self):
        self.messages = {}  # chat_id -> [messages]
        self.groups = {}

    async def send_message(self, session_id, peer, text):
        if peer not in self.messages:
            self.messages[peer] = []

        msg_id = len(self.messages[peer]) + 1
        self.messages[peer].append({
            "id": msg_id,
            "from": session_id,
            "text": text,
            "date": datetime.now()
        })

        return {"ok": True, "message_id": msg_id}

    async def get_chat_history(self, session_id, chat_id, limit):
        return self.messages.get(chat_id, [])[-limit:]
```

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–û–ë–ù–û–í–õ–ï–ù–û)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–°–ù–ê–ß–ê–õ–ê)

1. **–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã** ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è helpers –∏–∑ Admin API
2. **–õ–° –¥–∏–∞–ª–æ–≥–∏ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏** ‚Äî ConversationEngine
3. **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤** ‚Äî GroupEngine
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ü–û–¢–û–ú)

5. **–†–µ–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã** ‚Äî –ø–æ–∏—Å–∫ –∏ —É—á–∞—Å—Ç–∏–µ
6. **–ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤—Ä–µ–º–µ–Ω–∏** ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
7. **Stories** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–∞–∫—Ü–∏–∏

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

8. **–ì–æ–ª–æ—Å–æ–≤—ã–µ/—Å—Ç–∏–∫–µ—Ä—ã** ‚Äî —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
9. **–û–ø–µ—á–∞—Ç–∫–∏** ‚Äî –º–µ–ª–∫–∏–π —à—Ç—Ä–∏—Ö

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î** ‚Äî –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –≥—Ä—É–ø–ø
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é helpers** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Admin API
3. **–°–æ–∑–¥–∞—Ç—å ConversationAgent** ‚Äî LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
4. **–°–æ–∑–¥–∞—Ç—å ConversationEngine** ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤
5. **–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã** ‚Äî –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
6. **–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫** ‚Äî 5-10 –∞–∫–∫–∞—É–Ω—Ç–æ–≤

---

## –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

1. **Admin API endpoint** ‚Äî –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ endpoint –¥–ª—è —Å–ø–∞–º–±–ª–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤?
2. **–õ–∏–º–∏—Ç—ã –¥–∏–∞–ª–æ–≥–æ–≤** ‚Äî —Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç?
3. **–†–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø** ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤?
4. **–¢–µ–º—ã –≥—Ä—É–ø–ø** ‚Äî –∫–∞–∫–∏–µ —Ç–µ–º—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã?
